<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Browse all units in Anime Crusaders, including their abilities, stats, best traits and curses.">
    <title>Units - Anime Crusaders Wiki</title>
    <link rel="preload" href="favicon.ico" as="image" type="image/x-icon">
    <link rel="icon" type="image/x-icon" href="favicon.ico" crossorigin>
    <link rel="preload" href="styles/style.css" as="style">
    <link rel="preload" href="images/logo.webp" as="image">
    <link rel="preload" href="fonts/MundoSansBlack.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="data/units.json" as="fetch" crossorigin>
    <link rel="stylesheet" href="styles/style.css">
    <link rel="stylesheet" href="styles/units.css">
    <script src="scripts/common.js"></script>
    <script src="scripts/units.js"></script>
    <script>
        // Initialize global variables
        let allUnits = []; // Store all units globally
        let showBaseUnits = false; // Toggle state for base units
        let activeFilters = {
            rarity: new Set(),
            attribute: new Set(),
            damage: new Set(),
            element: new Set()
        };
        let matchAllElements = false;

        // Function to determine if a unit is a base version
        function isBaseUnit(unitId) {
            return !unitId.endsWith('_evo') && allUnits.some(unit => unit.id === `${unitId}_evo`);
        }

        // Function to setup base units toggle
        function setupBaseUnitsToggle() {
            const toggleUnevoBtn = document.getElementById('toggleUnevo');
            if (toggleUnevoBtn) {
                // Initial state
                showBaseUnits = false;
                toggleUnevoBtn.classList.remove('active');
                toggleUnevoBtn.textContent = 'Hide Unevolved Units';

                toggleUnevoBtn.addEventListener('click', () => {
                    showBaseUnits = !showBaseUnits;
                    toggleUnevoBtn.classList.toggle('active');
                    toggleUnevoBtn.textContent = showBaseUnits ? 'Show Unevolved Units' : 'Hide Unevolved Units';
                    
                    // Reapply filters and update display
                    const searchTerm = document.getElementById('unitSearch').value;
                    const filteredUnits = filterUnits(searchTerm);
                    displayUnits(filteredUnits);
                });
            }
        }

        // Extract image URLs from units data
        const imageUrlsExtractor = (data) => {
            return data.units.map(unit => `images/units/${unit.image}`);
        };

        async function loadUnits() {
            try {
                // Load data using common function with cache bypass
                const data = await loadData(
                    CACHE_KEYS.UNITS,
                    'data/units.json',
                    imageUrlsExtractor,
                    true // bypass cache to get fresh data
                );
                allUnits = data.units;
                // Apply the initial filter for base units
                const filteredUnits = filterUnits('');
                displayUnits(filteredUnits);

            } catch (error) {
                console.error('Error loading units:', error);
                document.getElementById('unitsList').innerHTML = 
                    '<p style="text-align: center; color: #ff4444;">Error loading units. Please try again later.</p>';
            }
        }

        // Add preload for units data
        addPreloadLink('data/units.json');

        // Load units when the page is ready
        ensureScriptLoaded(() => {
            loadUnits();
        });
    </script>
</head>
<body>
    <header>
        <div class="logo">
            <img src="images/logo.webp" alt="Anime Crusaders Logo">
        </div>
        <p class="subtitle">Anime Crusaders Wiki</p>
    </header>

    <nav>
        <a href="/acwiki">Home</a>
        <a href="units" class="active">Units</a>
        <a href="traits">Traits</a>
        <a href="items">Items</a>
        <a href="tierlist">Tier List</a>
        <a href="codes">Codes</a>
        <a href="update_logs">Update Logs</a>
        <a href="feedback">Feedback</a>
    </nav>

    <div class="container">
        <div class="section" id="units">
            <h2>ðŸ‘¥ Units</h2>
            <div class="search-container">
                <div class="search-row">
                    <input type="text" id="unitSearch" placeholder="Search units..." class="search-box">
                    <div class="button-group">
                        <button id="toggleFilters" class="toggle-filters-btn">Filters â–¼</button>
                        <button id="toggleUnevo" class="toggle-filters-btn">Hide Unevolved Units</button>
                    </div>
                </div>
                <div class="filters-container" id="filtersContainer">
                    <div class="filter-section">
                        <h4>Rarity</h4>
                        <div class="filter-buttons" id="rarityFilters">
                            <button class="filter-btn rarity-filter" data-type="rarity" data-value="Crusader">Crusader</button>
                            <button class="filter-btn rarity-filter" data-type="rarity" data-value="Secret">Secret</button>
                            <button class="filter-btn rarity-filter" data-type="rarity" data-value="Mythic">Mythic</button>
                            <button class="filter-btn rarity-filter" data-type="rarity" data-value="Legendary">Legendary</button>
                            <button class="filter-btn rarity-filter" data-type="rarity" data-value="Epic">Epic</button>
                            <button class="filter-btn rarity-filter" data-type="rarity" data-value="Rare">Rare</button>
                        </div>
                    </div>
                    <div class="filter-section">
                        <h4>Attribute</h4>
                        <div class="filter-buttons" id="attributeFilters">
                            <button class="filter-btn attribute-filter" data-type="attribute" data-value="Hybrid">Hybrid</button>
                            <button class="filter-btn attribute-filter" data-type="attribute" data-value="Ground">Ground</button>
                            <button class="filter-btn attribute-filter" data-type="attribute" data-value="Hill">Hill</button>
                            <button class="filter-btn attribute-filter" data-type="attribute" data-value="Summon">Summon</button>
                            <button class="filter-btn attribute-filter" data-type="attribute" data-value="Buff">Buff</button>
                            <button class="filter-btn attribute-filter" data-type="attribute" data-value="Farm">Farm</button>
                        </div>
                    </div>
                    <div class="filter-section">
                        <h4>Damage Type</h4>
                        <div class="filter-buttons" id="damageFilters">
                            <button class="filter-btn damage-filter" data-type="damage" data-value="Physical">Physical</button>
                            <button class="filter-btn damage-filter" data-type="damage" data-value="Magic">Magic</button>
                            <button class="filter-btn damage-filter" data-type="damage" data-value="True">True</button>
                        </div>
                    </div>
                    <div class="filter-section">
                        <div>
                            <h4>Element <button id="elementMatchToggle" class="toggle-match-btn" title="Toggle between matching any or all selected elements">Any</button></h4>
                        </div>
                        <div class="filter-buttons" id="elementFilters">
                            <button class="filter-btn element-filter" data-type="element" data-value="Fire">Fire</button>
                            <button class="filter-btn element-filter" data-type="element" data-value="Water">Water</button>
                            <button class="filter-btn element-filter" data-type="element" data-value="Lightning">Lightning</button>
                            <button class="filter-btn element-filter" data-type="element" data-value="Air">Air</button>
                            <button class="filter-btn element-filter" data-type="element" data-value="Rose">Rose</button>
                            <button class="filter-btn element-filter" data-type="element" data-value="Light">Light</button>
                            <button class="filter-btn element-filter" data-type="element" data-value="Dark">Dark</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tier-units" id="unitsList">
                <!-- Units will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <!-- Unit Info Modal -->
    <div id="unitInfoModal" class="modal">
        <div class="modal-content">
            <button class="close-modal">Ã—</button>
            <div class="modal-header">
                <img id="modalUnitImage" src="" alt="">
                <div class="modal-details">
                    <h2 id="modalUnitName"></h2>
                    <div class="modal-icons-container">
                        <div class="attributes-container" id="modalAttributes"></div>
                        <div class="damage-types-container" id="modalDamageTypes"></div>
                        <div class="elements-container" id="modalElements"></div>
                    </div>
                </div>
            </div>
            <div class="modal-body">
                <div class="modal-column">
                    <div class="modal-section" id="passiveSection" style="display: none;">
                        <h3>Passive(s)</h3>
                        <div id="modalPassive"></div>
                    </div>
                    <div class="modal-section" id="abilitySection" style="display: none;">
                        <h3>Ability</h3>
                        <div id="modalAbilities"></div>
                    </div>
                </div>
                <div class="modal-column">
                    <div class="modal-section" id="statsSection">
                        <h3>Base Stats (Max Level)</h3>
                        <div class="stat-grid" id="modalStats"></div>
                    </div>
                    <div class="modal-section" id="costSection">
                        <h3>Cost</h3>
                        <div class="stat-grid" id="modalCosts"></div>
                    </div>
                    <div class="modal-section" id="traitsAndCurseSection">
                        <div class="traits-and-curse-content">
                            <h3 id="traitsHeader">Best Traits and Curse</h3>
                            <div class="traits-container">
                                <div class="traits-section">
                                    <h4>Progressive</h4>
                                    <div class="traits-and-curse" id="modalItemsProg"></div>
                                </div>
                                <div class="traits-section">
                                    <h4>Infinite</h4>
                                    <div class="traits-and-curse" id="modalItemsInf"></div>
                                </div>
                            </div>
                            <div class="curse-container" id="modalBestCurse">
                                <span id="modalCurseText"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const modal = document.getElementById('unitInfoModal');
        const closeButton = modal.querySelector('.close-modal');

        async function showUnitInfo(unitInfo) {
            try {
                if (!unitInfo) {
                    console.error('Unit info not found');
                    return;
                }

                // Basic Info
                document.getElementById('modalUnitImage').src = `images/units/${unitInfo.image}`;
                document.getElementById('modalUnitName').textContent = unitInfo.name;

                // Attributes, Damage Types and Elements
                const attributesContainer = document.getElementById('modalAttributes');
                const damageTypesContainer = document.getElementById('modalDamageTypes');
                const elementsContainer = document.getElementById('modalElements');

                // Clear previous icons and badges
                attributesContainer.innerHTML = '';
                
                // Add attribute badges
                if (unitInfo.attributes && unitInfo.attributes.length > 0) {
                    unitInfo.attributes.forEach(attr => {
                        const badge = document.createElement('span');
                        badge.className = 'attribute-badge';
                        badge.setAttribute('data-value', attr);
                        badge.textContent = attr;
                        attributesContainer.appendChild(badge);
                    });
                }
                
                // Clear previous icons
                damageTypesContainer.innerHTML = '';
                elementsContainer.innerHTML = '';
                
                // Add damage type icons if they exist
                if (unitInfo.damage_type && unitInfo.damage_type.length > 0) {
                    unitInfo.damage_type.forEach(type => {
                        const img = document.createElement('img');
                        img.src = `images/icons/damage_types/${type.toLowerCase()}.png`;
                        img.alt = type;
                        img.title = type;
                        img.className = 'damage-type-icon';
                        damageTypesContainer.appendChild(img);
                    });
                }
                
                // Add element icons if they exist
                if (unitInfo.elements && unitInfo.elements.length > 0) {
                    unitInfo.elements.forEach(element => {
                        const img = document.createElement('img');
                        img.src = `images/icons/elements/${element.toLowerCase()}.png`;
                        img.alt = element;
                        img.title = element;
                        img.className = 'element-icon';
                        elementsContainer.appendChild(img);
                    });
                }

                // Stats
                const statsContainer = document.getElementById('modalStats');
                statsContainer.innerHTML = '';
                const statLabels = {
                    damage: "Damage",
                    spa: "SPA",
                    range: "Range",
                    yen: "Yen",
                    hp: "HP"
                };
                
                if (unitInfo.attributes.includes('Farm')) {
                    // Only show Yen stat for farm units
                    if (unitInfo.stats.yen) {
                        const statItem = document.createElement('div');
                        statItem.className = 'stat-item';
                        statItem.innerHTML = `
                            <span>${statLabels.yen}</span>
                            <span>${unitInfo.stats.yen}Â¥</span>
                        `;
                        statsContainer.appendChild(statItem);
                    }
                } else {
                    // Determine which stats to show based on unit type
                    let statsToShow = ['spa'];
                    
                    // Add range only for non-Summon units
                    if (!unitInfo.attributes.includes('Summon')) {
                        statsToShow.push('range');
                    }
                    
                    // Add damage or HP based on summoner status
                    if (unitInfo.attributes.includes('Summon')) {
                        statsToShow.unshift('hp'); // Add HP at the beginning
                    } else {
                        statsToShow.unshift('damage'); // Add damage at the beginning
                    }

                    // Show the appropriate stats for the unit type
                    statsToShow.forEach(stat => {
                        if (stat in unitInfo.stats) {
                            const statItem = document.createElement('div');
                            statItem.className = 'stat-item';
                            
                            // Format the display value based on the stat type
                            let displayValue = unitInfo.stats[stat];
                            if (stat === 'spa') {
                                displayValue = displayValue + 's';
                            } else if (typeof displayValue === 'number') {
                                displayValue = displayValue.toLocaleString();
                            }

                            statItem.innerHTML = `
                                <span>${statLabels[stat]}</span>
                                <span>${displayValue}</span>
                            `;
                            statsContainer.appendChild(statItem);
                        }
                    });
                }

                // Cost Information
                const costsContainer = document.getElementById('modalCosts');
                costsContainer.innerHTML = '';
                
                // Add placement cost
                const placementItem = document.createElement('div');
                placementItem.className = 'stat-item';
                placementItem.innerHTML = `
                    <span>Placement</span>
                    <span>${unitInfo.placement_cost.toLocaleString()}Â¥</span>
                `;
                costsContainer.appendChild(placementItem);

                // Add max upgrade cost
                const upgradeItem = document.createElement('div');
                upgradeItem.className = 'stat-item';
                upgradeItem.innerHTML = `
                    <span>Max Upgrade</span>
                    <span>${unitInfo.max_upgrade_cost.toLocaleString()}Â¥</span>
                `;
                costsContainer.appendChild(upgradeItem);

                // Ability
                const abilitySection = document.getElementById('abilitySection');
                const abilitiesContainer = document.getElementById('modalAbilities');
                abilitiesContainer.innerHTML = '';
                if (unitInfo.has_ability && unitInfo.ability.name) {
                    const abilityItem = document.createElement('div');
                    abilityItem.className = 'ability-item';
                    const cooldownText = unitInfo.ability.global ? `CD: ${unitInfo.ability.cooldown}s Global` : `CD: ${unitInfo.ability.cooldown}s`;
                    const upgradeText = unitInfo.ability.upgrade > 0 ? `Upgrade ${unitInfo.ability.upgrade} â€¢ ` : '';
                    abilityItem.innerHTML = `
                        <h4>${unitInfo.ability.name} <span class="cooldown">${upgradeText}${cooldownText}</span></h4>
                        <p>${unitInfo.ability.description.replace(/\n/g, '<br>')}</p>
                    `;
                    abilitiesContainer.appendChild(abilityItem);
                    abilitySection.style.display = 'block';
                } else {
                    abilitySection.style.display = 'none';
                }

                // Passive
                const passiveSection = document.getElementById('passiveSection');
                const passiveContainer = document.getElementById('modalPassive');
                if (unitInfo.has_passive && unitInfo.passive.length > 0) {
                    passiveContainer.innerHTML = unitInfo.passive.map(p => {
                        const upgradeText = p.upgrade > 0 ? `Upgrade ${p.upgrade}` : '';
                        const cooldownText = p.cooldown > 0 ? `CD: ${p.cooldown}s` : '';
                        const metadataText = [upgradeText, cooldownText].filter(Boolean).join(' â€¢ ');
                        const metadataSpan = metadataText ? ` <span class="cooldown">${metadataText}</span>` : '';
                        
                        return `
                            <div class="ability-item">
                                <h4>${p.name}${metadataSpan}</h4>
                                <p>${p.description.replace(/\n/g, '<br>')}</p>
                            </div>
                        `;
                    }).join('');
                    passiveSection.style.display = 'block';
                } else {
                    passiveSection.style.display = 'none';
                }

                // Move stats section if both passive and ability are hidden
                const statsSection = document.getElementById('statsSection');
                const leftColumn = document.querySelector('.modal-column:first-child');
                const rightColumn = document.querySelector('.modal-column:last-child');
                
                if (!unitInfo.has_passive && !unitInfo.has_ability) {
                    leftColumn.appendChild(statsSection);
                } else {
                    rightColumn.insertBefore(statsSection, rightColumn.firstChild);
                }

                // Handle traits and curse section
                const traitsAndCurseSection = document.getElementById('traitsAndCurseSection');
                const traitsContainer = document.querySelector('.traits-container');
                const curseContainer = document.getElementById('modalBestCurse');
                const traitsHeader = document.getElementById('traitsHeader');
                const progContainer = document.getElementById('modalItemsProg');
                const infContainer = document.getElementById('modalItemsInf');

                // First check if we should show the section at all
                if (!unitInfo.traits && !unitInfo.curse) {
                    traitsAndCurseSection.style.display = 'none';
                } else {
                    traitsAndCurseSection.style.display = 'block';
                    
                    // Reset all containers
                    traitsContainer.style.display = 'none';
                    curseContainer.style.display = 'none';

                    let hasVisibleTraits = false;
                    let hasVisibleCurse = false;

                    // Show traits if they exist
                    if (unitInfo.traits) {
                        traitsContainer.style.display = 'flex';
                        hasVisibleTraits = true;
                    }

                    // Show curse if it exists and has values
                    if (unitInfo.curse && unitInfo.best_curse && unitInfo.best_curse[0]) {
                        curseContainer.style.display = 'flex';
                        hasVisibleCurse = true;
                    }

                    // Update header based on what's actually visible
                    if (hasVisibleTraits && hasVisibleCurse) {
                        traitsHeader.textContent = 'Best Traits and Curse';
                    } else if (hasVisibleTraits) {
                        traitsHeader.textContent = 'Best Traits';
                    } else if (hasVisibleCurse) {
                        traitsHeader.textContent = 'Best Curse';
                    }
                }

                // Handle traits
                if (unitInfo.traits) {
                    traitsContainer.style.display = 'flex';
                    progContainer.innerHTML = '';
                    infContainer.innerHTML = '';

                    // Progressive traits
                    unitInfo.best_traits_progressive.forEach(trait => {
                        const traitWrapper = document.createElement('div');
                        traitWrapper.className = 'trait-wrapper';
                        const traitImg = document.createElement('img');
                        traitImg.src = `images/traits/${trait.toLowerCase()}.png`;
                        traitImg.alt = trait;
                        traitImg.title = trait;
                        traitWrapper.appendChild(traitImg);
                        progContainer.appendChild(traitWrapper);
                    });

                    // Infinite traits
                    unitInfo.best_traits_infinite.forEach(trait => {
                        const traitWrapper = document.createElement('div');
                        traitWrapper.className = 'trait-wrapper';
                        const traitImg = document.createElement('img');
                        traitImg.src = `images/traits/${trait.toLowerCase()}.png`;
                        traitImg.alt = trait;
                        traitImg.title = trait;
                        traitWrapper.appendChild(traitImg);
                        infContainer.appendChild(traitWrapper);
                    });
                } else {
                    traitsContainer.style.display = 'none';
                }

                // Handle curse
                const curseText = document.getElementById('modalCurseText');
                if (unitInfo.curse && unitInfo.best_curse && unitInfo.best_curse[0]) {
                    curseContainer.style.display = 'flex';
                    curseText.innerHTML = `
                        <span class="good-curse"><strong>${unitInfo.best_curse[0]}</strong> <strong>â†‘</strong></span>
                        <span class="separator">|</span>
                        <span class="bad-curse"><strong>â†“</strong> <strong>${unitInfo.best_curse[1] || 'None'}</strong></span>
                    `;
                } else {
                    curseContainer.style.display = 'none';
                }

                // Update header based on what's being shown
                if (unitInfo.traits && unitInfo.curse) {
                    traitsHeader.textContent = 'Best Traits and Curse';
                } else if (unitInfo.traits) {
                    traitsHeader.textContent = 'Best Traits';
                } else if (unitInfo.curse) {
                    traitsHeader.textContent = 'Best Curse';
                }

                openModal();
            } catch (error) {
                console.error('Error loading unit info:', error);
            }
        }

        function closeModal() {
            modal.classList.add('closing');
            document.body.style.overflow = 'auto';
            
            // Wait for animation to complete before hiding the modal
            setTimeout(() => {
                modal.style.display = 'none';
                modal.classList.remove('closing');
            }, 300); // Match the animation duration
        }

        function openModal() {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            // Force a reflow to ensure the animation plays
            void modal.offsetWidth;
            modal.classList.remove('closing');
        }

        // Close modal when clicking the close button
        closeButton.addEventListener('click', closeModal);

        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.style.display === 'block') {
                closeModal();
            }
        });

        // Window-level variables declaration moved to top level for consistency

        function displayUnits(units) {
            const container = document.getElementById('unitsList');
            container.innerHTML = ''; // Clear existing units
            
            units.forEach(unitInfo => {
                const unitCard = document.createElement('div');
                unitCard.className = 'unit-card interactive-card';
                
                const img = document.createElement('img');
                img.src = `images/units/${unitInfo.image}`;
                img.alt = unitInfo.name;
                unitCard.title = unitInfo.name; // Add tooltip with unit name
                
                unitCard.addEventListener('click', () => showUnitInfo(unitInfo));
                
                unitCard.appendChild(img);
                container.appendChild(unitCard);
            });
        }

        function filterUnits(searchTerm) {
            if (!allUnits || !Array.isArray(allUnits)) {
                console.error('Units array is not properly initialized:', allUnits);
                return [];
            }
            // Make a copy of the units array to avoid mutating the original
            let filteredUnits = [...allUnits];

            // First apply the base units filter
            if (showBaseUnits) {
                filteredUnits = filteredUnits.filter(unit => !isBaseUnit(unit.id));
            }
            
            console.log('Filtering units, total units:', filteredUnits.length);

            // Apply search filter
            if (searchTerm) {
                searchTerm = searchTerm.toLowerCase();
                filteredUnits = filteredUnits.filter(unit => {
                    // Check the main name
                    if (unit.name.toLowerCase().includes(searchTerm)) {
                        return true;
                    }
                    // Check alternatives if they exist
                    if (unit.alternatives && Array.isArray(unit.alternatives)) {
                        return unit.alternatives.some(alt => alt.toLowerCase().includes(searchTerm));
                    }
                    return false;
                });
                console.log('After search filter:', filteredUnits.length);
            }

            // Apply rarity filters
            if (activeFilters.rarity.size > 0) {
                filteredUnits = filteredUnits.filter(unit => activeFilters.rarity.has(unit.rarity));
                console.log('After rarity filter:', filteredUnits.length);
            }

            // Apply attribute filters
            if (activeFilters.attribute.size > 0) {
                filteredUnits = filteredUnits.filter(unit => 
                    Array.from(activeFilters.attribute).some(attr => unit.attributes.includes(attr))
                );
                console.log('After attribute filter:', filteredUnits.length);
            }

            // Apply damage type filters
            if (activeFilters.damage.size > 0) {
                filteredUnits = filteredUnits.filter(unit => 
                    unit.damage_type.some(type => activeFilters.damage.has(type))
                );
                console.log('After damage type filter:', filteredUnits.length);
            }

            // Apply element filters
            if (activeFilters.element.size > 0) {
                filteredUnits = filteredUnits.filter(unit => {
                    if (!unit.elements) return false;
                    if (matchAllElements) {
                        // Unit must have all selected elements
                        return Array.from(activeFilters.element).every(element => 
                            unit.elements.includes(element)
                        );
                    } else {
                        // Unit must have at least one of the selected elements
                        return unit.elements.some(element => 
                            activeFilters.element.has(element)
                        );
                    }
                });
                console.log('After element filter:', filteredUnits.length);
            }
            
            return filteredUnits;
        }

        // Handle filter clicks
        function initializeFilters() {
            console.log('Initializing filters...'); // Debug log
            const filterButtons = document.querySelectorAll('.filter-btn');
            console.log('Found filter buttons:', filterButtons.length); // Debug log
            
            // Remove existing event listeners first
            filterButtons.forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
            });
            
            // Add new event listeners
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    console.log('Filter clicked:', this.dataset.type, this.dataset.value); // Debug log
                    const type = this.dataset.type;
                    const value = this.dataset.value;
                    
                    if (activeFilters[type].has(value)) {
                        activeFilters[type].delete(value);
                        this.classList.remove('active');
                    } else {
                        activeFilters[type].add(value);
                        this.classList.add('active');
                    }
                    
                    // Reapply filters
                    const searchTerm = document.getElementById('unitSearch').value;
                    const filteredUnits = filterUnits(searchTerm);
                    displayUnits(filteredUnits);
                });
            });
        }

        // Initialize everything after units are loaded
        async function initializeUI() {
            try {
                // First load the units
                await loadUnits();
                console.log('Units loaded:', allUnits.length); // Debug log

                // Initialize toggle filters
                initializeToggleFilters();
                console.log('Toggle filters initialized');

                // Then initialize filters
                initializeFilters();
                console.log('Filters initialized');

                // Set up search functionality
                const searchBox = document.getElementById('unitSearch');
                searchBox.addEventListener('input', (e) => {
                    const filteredUnits = filterUnits(e.target.value);
                    displayUnits(filteredUnits);
                });
                console.log('Search functionality initialized');

                // Setup base units toggle
                setupBaseUnitsToggle();
                console.log('Base units toggle initialized');

                // Initial display of filtered units
                const filteredUnits = filterUnits('');
                displayUnits(filteredUnits);
                console.log('Initial units displayed');
            } catch (error) {
                console.error('Error initializing UI:', error);
            }
        }

        // Remove previous event listeners if any
        window.removeEventListener('load', initializeUI);
        // Initialize everything when the page loads
        window.addEventListener('load', initializeUI);

        // Initialize toggle filters functionality
        function initializeToggleFilters() {
            console.log('Initializing toggle filters...'); // Debug log
            const toggleButton = document.getElementById('toggleFilters');
            const filtersContainer = document.getElementById('filtersContainer');
            const elementMatchToggle = document.getElementById('elementMatchToggle');
            
            if (!toggleButton || !filtersContainer) {
                console.error('Toggle button or filters container not found');
                return;
            }

            // Remove any existing listeners
            const newToggleButton = toggleButton.cloneNode(true);
            toggleButton.parentNode.replaceChild(newToggleButton, toggleButton);
            
            // Add new click listener for filters toggle
            newToggleButton.addEventListener('click', () => {
                console.log('Toggle button clicked'); // Debug log
                filtersContainer.classList.toggle('show');
                newToggleButton.classList.toggle('active');
                newToggleButton.textContent = filtersContainer.classList.contains('show') ? 'Filters â–²' : 'Filters â–¼';
            });

            if (elementMatchToggle) {
                const newElementMatchToggle = elementMatchToggle.cloneNode(true);
                elementMatchToggle.parentNode.replaceChild(newElementMatchToggle, elementMatchToggle);

                newElementMatchToggle.addEventListener('click', () => {
                    console.log('Element match toggle clicked'); // Debug log
                    matchAllElements = !matchAllElements;
                    newElementMatchToggle.classList.toggle('match-all');
                    newElementMatchToggle.textContent = matchAllElements ? 'All' : 'Any';
                    
                    // Reapply filters with new matching logic
                    const searchTerm = document.getElementById('unitSearch').value;
                    const filteredUnits = filterUnits(searchTerm);
                    displayUnits(filteredUnits);
                });
            }
        }

        // Ensure script is loaded before initializing
        ensureScriptLoaded(() => {
            initializeUI();
        });
    </script>

    <footer>
        <p>Anime Crusaders Wiki by Raksha</p>
    </footer>
</body>
</html>